<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="stylesheet" href="css/leaflet.css">
    <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
    <link rel="stylesheet" href="css/qgis2web.css">
    <link rel="stylesheet" href="css/fontawesome-all.min.css">
    <link rel="stylesheet" href="css/leaflet-control-geocoder.Geocoder.css">
    <link rel="stylesheet" href="css/leaflet-measure.css">
    <style>
        html, body, #map {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }

        .map-logo {
            position: absolute;
            bottom: 10px;
            left: 10px;
            width: 80px;
            opacity: 0.8;
            z-index: 1000;
            pointer-events: none;
        }
    </style>
    <title>Propriedades Aderidas ao Programa Águas Para Sempre</title>
</head>
<body>
    <div id="map" style="position: relative;">
        <img class="map-logo" src="images/LOGOPSA.png" alt="Logotipo do Programa Águas para Sempre">
    </div>

    <!-- Load Scripts -->
    <script src="js/qgis2web_expressions.js"></script>
    <script src="js/leaflet.js"></script>
    <script src="js/L.Control.Layers.Tree.min.js"></script>
    <script src="js/multi-style-layer.js"></script>
    <script src="js/leaflet.rotatedMarker.js"></script>
    <script src="js/leaflet.pattern.js"></script>
    <script src="js/leaflet-hash.js"></script>
    <script src="js/Autolinker.min.js"></script>
    <script src="js/rbush.min.js"></script>
    <script src="js/labelgun.min.js"></script>
    <script src="js/labels.js"></script>
    <script src="js/leaflet-control-geocoder.Geocoder.js"></script>
    <script src="js/leaflet-measure.js"></script>
    <script src="data/LotesRurais_2.js"></script>
    <script src="data/LimitedoPrograma_3.js"></script>
    <script src="data/reasaderidasaoPSA_4.js"></script>

    <script>
    var map = L.map('map', {
        zoomControl: false,
        maxZoom: 28,
        minZoom: 4
    }).fitBounds([
        [-26.20830528134927, -49.02332694324076],
        [-26.158213945930385, -48.949884229538924]
    ]);

    new L.Hash(map);

    map.attributionControl.setPrefix(`
        <a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot;
        <a href="https://leafletjs.com">Leaflet</a> &middot;
        <a href="https://qgis.org">QGIS</a>`);

    var autolinker = new Autolinker({ truncate: { length: 30, location: 'smart' } });

    function removeEmptyRowsFromPopupContent(content, feature) {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = content;
        tempDiv.querySelectorAll('tr').forEach(row => {
            const td = row.querySelector('td.visible-with-data');
            if (td && feature.properties[td.id] == null) {
                row.remove();
            }
        });
        return tempDiv.innerHTML;
    }

    function addClassToPopupIfMedia(content, popup) {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = content;
        if (tempDiv.querySelector('td img')) {
            popup._contentNode.classList.add('media');
            setTimeout(() => popup.update(), 10);
        } else {
            popup._contentNode.classList.remove('media');
        }
    }

    // Add Title
    const title = new L.Control({ position: 'topright' });
    title.onAdd = function () {
        this._div = L.DomUtil.create('div', 'info');
        this.update();
        return this._div;
    };
    title.update = () => {
        title._div.innerHTML = '<h2>Áreas de Propriedades Aderidas ao Programa PSA</h2>';
    };
    title.addTo(map);

    // Controls
    L.control.zoom({ position: 'topleft' }).addTo(map);
    new L.Control.Measure({
        position: 'topleft',
        primaryLengthUnit: 'meters',
        secondaryLengthUnit: 'kilometers',
        primaryAreaUnit: 'sqmeters',
        secondaryAreaUnit: 'hectares'
    }).addTo(map);
    document.querySelector('.leaflet-control-measure-toggle').innerHTML = '';
    document.querySelector('.leaflet-control-measure-toggle').classList.add('fas', 'fa-ruler');

    const bounds_group = new L.featureGroup([]);

    // Basemaps
    const layer_GoogleSatellite = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
        pane: 'pane_GoogleSatellite',
        opacity: 1.0,
        attribution: 'Map data ©2015 Google',
        minZoom: 4,
        maxZoom: 28,
        maxNativeZoom: 20
    }).addTo(map);

    const layer_Positron = L.tileLayer('https://a.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
        pane: 'pane_Positron',
        opacity: 1.0,
        attribution: 'CartoDB © OpenStreetMap contributors',
        minZoom: 4,
        maxZoom: 28,
        maxNativeZoom: 20
    }).addTo(map);

    // Layer: LotesRurais
    const layer_LotesRurais = new L.geoJson(json_LotesRurais_2, {
        style: () => ({
            color: 'rgba(121,121,121,0.72)',
            weight: 1,
            fillOpacity: 0,
            interactive: false
        }),
        onEachFeature: (feature, layer) => {
            const popupContent = '<table><tr><td>Lote ID:</td><td>' +
                (feature.properties['id'] || 'N/A') + '</td></tr></table>';
            const content = removeEmptyRowsFromPopupContent(popupContent, feature);
            layer.on('popupopen', e => addClassToPopupIfMedia(content, e.popup));
            layer.bindPopup(content, { maxHeight: 400 });
        }
    }).addTo(map);
    bounds_group.addLayer(layer_LotesRurais);

    // Layer: Limite do Programa
    const layer_LimitePrograma = new L.geoJson(json_LimitedoPrograma_3, {
        style: () => ({
            color: 'rgba(47,31,205,1.0)',
            dashArray: '3,6',
            weight: 3,
            fillOpacity: 0,
            interactive: false
        }),
        onEachFeature: (feature, layer) => {
            const popupContent = '<table><tr><td>Limite:</td><td>' +
                (feature.properties['nome'] || 'N/A') + '</td></tr></table>';
            const content = removeEmptyRowsFromPopupContent(popupContent, feature);
            layer.on('popupopen', e => addClassToPopupIfMedia(content, e.popup));
            layer.bindPopup(content, { maxHeight: 400 });
        }
    }).addTo(map);
    bounds_group.addLayer(layer_LimitePrograma);

    // Layer: Áreas aderidas ao PSA
    const layer_reasaderidasaoPSA = new L.geoJson(json_reasaderidasaoPSA_4, {
        style: () => ({
            color: '#232323',
            weight: 1,
            fillOpacity: 0.9,
            fillColor: 'rgba(57,80,255,0.77)'
        }),
        onEachFeature: (feature, layer) => {
            const props = feature.properties;
            const popupContent = `<table>
                <tr><th>Lote</th><td id="iq_lote" class="visible-with-data">${autolinker.link(props.iq_lote || '')}</td></tr>
                <tr><th>Propriedade</th><td id="prp" class="visible-with-data">${autolinker.link(props.prp || '')}</td></tr>
                <tr><th>CAR</th><td id="car" class="visible-with-data">${autolinker.link(props.car || '')}</td></tr>
                <tr><td colspan="2">${autolinker.link(props.link_pdf || '')}</td></tr>
            </table>`;
            const content = removeEmptyRowsFromPopupContent(popupContent, feature);
            layer.on('popupopen', e => addClassToPopupIfMedia(content, e.popup));
            layer.bindPopup(content, { maxHeight: 400 });
        }
    }).addTo(map);
    bounds_group.addLayer(layer_reasaderidasaoPSA);

    // Geocoder
    const geocoder = new L.Control.Geocoder({ collapsed: true, position: 'topleft' }).addTo(map);
    document.querySelector('.leaflet-control-geocoder-icon').classList.add('fa', 'fa-search');

    // Tree Control
    L.control.layers.tree(null, [
        { label: '<img src="legend/reasaderidasaoPSA_4.png" /> Áreas aderidas ao PSA', layer: layer_reasaderidasaoPSA },
        { label: '<img src="legend/LimitedoPrograma_3.png" /> Limite do Programa', layer: layer_LimitePrograma },
        { label: '<img src="legend/LotesRurais_2.png" /> Lotes Rurais', layer: layer_LotesRurais },
        { label: "Positron", layer: layer_Positron, radioGroup: 'bm' },
        { label: "Google Satellite", layer: layer_GoogleSatellite, radioGroup: 'bm' }
    ], { collapsed: true }).addTo(map);

    // Debounced label reset
    const debounce = (func, wait) => {
        let timeout;
        return () => {
            clearTimeout(timeout);
            timeout = setTimeout(func, wait);
        };
    };
    const resetLayerLabels = debounce(() => resetLabels([layer_reasaderidasaoPSA]), 200);

    map.on("zoomend", resetLayerLabels);
    map.on("layeradd", resetLayerLabels);
    map.on("layerremove", resetLayerLabels);
    </script>
</body>
</html>